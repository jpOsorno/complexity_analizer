// ============================================================================
// GRAMÁTICA LARK - VERSIÓN CORREGIDA
// ============================================================================

?start: program

program: (class_definition)* procedure_definition+

// ============================================================================
// CLASES
// ============================================================================
class_definition: IDENTIFIER "{" attribute_list "}"

attribute_list: IDENTIFIER+

// ============================================================================
// PROCEDIMIENTOS
// ============================================================================
procedure_definition: IDENTIFIER "(" parameter_list? ")" block

parameter_list: parameter ("," parameter)*

parameter: class_param | array_param | simple_param

class_param: "Clase" IDENTIFIER

array_param: IDENTIFIER ("[" NUMBER? "]")+

simple_param: IDENTIFIER

// ============================================================================
// BLOQUES
// ============================================================================
block: "begin" declaration* statement* "end"

?declaration: local_array_decl | local_object_decl

local_array_decl: IDENTIFIER ("[" expression? "]")+

local_object_decl: "Clase" IDENTIFIER

// ============================================================================
// SENTENCIAS
// ============================================================================
?statement: for_statement
          | while_statement
          | repeat_statement
          | if_statement
          | assignment
          | call_statement
          | return_statement
          | COMMENT

for_statement: "for" IDENTIFIER "←" expression "to" expression "do" block

while_statement: "while" "(" boolean_expression ")" "do" block

repeat_statement: "repeat" statement+ "until" "(" boolean_expression ")"

if_statement: "if" "(" boolean_expression ")" "then" block ("else" block)?

// ASIGNACIÓN CORREGIDA
assignment: lvalue "←" expression

// LVALUE SIMPLIFICADO (sin ambigüedad)
lvalue: IDENTIFIER ("[" expression "]")+ ("." IDENTIFIER)*     -> array_object_lvalue
      | IDENTIFIER ("." IDENTIFIER)+                            -> object_lvalue
      | IDENTIFIER                                               -> variable_lvalue

call_statement: "call" IDENTIFIER "(" argument_list? ")"

argument_list: expression ("," expression)*

return_statement: "return" expression?

// ============================================================================
// EXPRESIONES
// ============================================================================

?expression: boolean_expression

// ----------------------------------------------------------------------------
// BOOLEANAS
// ----------------------------------------------------------------------------
?boolean_expression: boolean_term
                   | boolean_expression "or" boolean_term    -> or_op

?boolean_term: boolean_factor
             | boolean_term "and" boolean_factor           -> and_op

?boolean_factor: "not" boolean_factor     -> not_op
               | relational_expression
               | "(" boolean_expression ")"
               | BOOLEAN

// ----------------------------------------------------------------------------
// RELACIONALES
// ----------------------------------------------------------------------------
?relational_expression: arithmetic_expression
                      | arithmetic_expression "<" arithmetic_expression   -> lt
                      | arithmetic_expression ">" arithmetic_expression   -> gt
                      | arithmetic_expression "≤" arithmetic_expression   -> le
                      | arithmetic_expression "<=" arithmetic_expression  -> le
                      | arithmetic_expression "≥" arithmetic_expression   -> ge
                      | arithmetic_expression ">=" arithmetic_expression  -> ge
                      | arithmetic_expression "=" arithmetic_expression   -> eq
                      | arithmetic_expression "≠" arithmetic_expression   -> ne
                      | arithmetic_expression "<>" arithmetic_expression  -> ne

// ----------------------------------------------------------------------------
// ARITMÉTICAS
// ----------------------------------------------------------------------------
?arithmetic_expression: term
                      | arithmetic_expression "+" term    -> add
                      | arithmetic_expression "-" term    -> sub

?term: factor
     | term "*" factor      -> mul
     | term "/" factor      -> div
     | term "mod" factor    -> mod
     | term "div" factor    -> int_div

?factor: power
       | "+" factor          -> pos
       | "-" factor          -> neg

?power: primary
      | primary "^" factor   -> pow

// PRIMARY CORREGIDO (sin ambigüedad)
?primary: NUMBER
        | STRING
        | BOOLEAN
        | "NULL"                                         -> null_literal
        | length_function
        | ceiling_function
        | floor_function
        | function_call
        | "(" arithmetic_expression ")"
        | IDENTIFIER ("[" array_index "]")+ ("." IDENTIFIER)*   -> array_object_access
        | IDENTIFIER ("." IDENTIFIER)+                          -> object_access
        | IDENTIFIER                                             -> identifier

// ----------------------------------------------------------------------------
// FUNCIONES
// ----------------------------------------------------------------------------
function_call: "call" IDENTIFIER "(" argument_list? ")"

array_index: expression
           | expression ".." expression      // rango

length_function: "length" "(" IDENTIFIER ")"

ceiling_function: "┌" expression "┐"
                | "ceil" "(" expression ")"

floor_function: "└" expression "┘"
              | "floor" "(" expression ")"

// ============================================================================
// TOKENS
// ============================================================================

STRING: /"[^"]*"/ | /'[^']*'/

BOOLEAN: "T" | "F" | "true" | "false"

NUMBER: /\d+(\.\d+)?/

IDENTIFIER: /[a-zA-Z_][a-zA-Z0-9_]*/

COMMENT: "►" /[^\n]*/

// ============================================================================
// WHITESPACE
// ============================================================================
%import common.WS
%ignore WS
%ignore COMMENT